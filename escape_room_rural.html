<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Escape Room Digital - La Casa Rural Misteriosa (Firebase)</title>
    <link href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.0.0/css/all.min.css">
    <style>
        /* --- ESTILOS CSS (Sin cambios, los mismos que antes) --- */
        @import url('https://fonts.googleapis.com/css2?family=Creepster&family=Roboto:wght@300;400;700&display=swap');
        body{font-family:'Roboto',sans-serif;background-color:#f0f2f5}
        .title-font{font-family:'Creepster',cursive}
        .game-container{max-width:1200px;margin:0 auto}
        .puzzle-item{transition:all 0.3s ease}
        .puzzle-item:hover{transform:scale(1.05)}
        .lock-animation{animation:wiggle 0.5s ease}
        @keyframes wiggle{0%,100%{transform:rotate(0deg)}25%{transform:rotate(-5deg)}75%{transform:rotate(5deg)}}
        .timer-warning{animation:pulse 2s infinite}
        @keyframes pulse{0%{opacity:1}50%{opacity:0.5}100%{opacity:1}}
        .puzzle-piece{cursor:pointer;transition:transform 0.2s}
        .puzzle-piece:hover{transform:scale(1.05)}
        .draggable{cursor:move}
        .hint-badge{position:absolute;top:-5px;right:-5px;background-color:red;color:white;border-radius:50%;width:20px;height:20px;font-size:12px;display:flex;align-items:center;justify-content:center}
        .code-digit{width:40px;height:50px;font-size:24px;text-align:center;margin:0 5px;border:2px solid #ccc;border-radius:5px}
        .hidden-clue{position:relative;background-color:#000;color:#000;user-select:none;cursor:pointer}
        .revealed{background-color:transparent;color:inherit}
        ::-webkit-scrollbar{width:8px}
        ::-webkit-scrollbar-track{background:#f1f1f1}
        ::-webkit-scrollbar-thumb{background:#888;border-radius:4px}
        ::-webkit-scrollbar-thumb:hover{background:#555}
        .audio-player{width:100%;max-width:300px;margin:10px auto}
        .progress-container{height:5px;background-color:#ddd;border-radius:5px;margin-bottom:5px;cursor:pointer}
        .progress-bar{height:100%;background-color:#4CAF50;border-radius:5px;width:0%}
        .morse-dot{display:inline-block;width:10px;height:10px;border-radius:50%;background-color:#333;margin:0 2px}
        .morse-dash{display:inline-block;width:20px;height:10px;background-color:#333;margin:0 2px}
        .morse-space{display:inline-block;width:15px;margin:0 2px}
        .cipher-table td{width:30px;height:30px;text-align:center;border:1px solid #ddd}
        /* Estilo para mensajes de espera/error */
        .status-message { font-style: italic; color: #555; margin-top: 10px; text-align: center; }
    </style>
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
</head>
<body class="bg-gray-100">
    <div id="app" class="min-h-screen">
        <!-- Loading Screen -->
        <div id="loading-screen" class="fixed inset-0 bg-black z-50 flex flex-col items-center justify-center text-white">
            <h1 class="title-font text-5xl mb-8 text-red-600">La Casa Rural Misteriosa</h1>
            <div class="w-64 h-2 bg-gray-800 rounded-full">
                <div id="loading-bar" class="h-full bg-red-600 rounded-full" style="width: 0%"></div>
            </div>
            <p id="loading-text" class="mt-4 text-xl">Conectando con el misterio...</p>
        </div>

        <!-- Login / Welcome Screen -->
        <div id="login-screen" class="min-h-screen hidden flex flex-col items-center justify-center p-4">
             <div class="max-w-md w-full bg-white rounded-lg shadow-lg overflow-hidden">
                <div class="p-4 bg-red-800 text-white">
                    <h2 class="title-font text-3xl text-center">La Casa Rural Misteriosa</h2>
                    <p class="text-center text-sm mt-2">Escape Room Digital (Firebase)</p>
                </div>
                <div class="p-6">
                    <div class="mb-6 text-center">
                        <p class="text-gray-700">Bienvenidos. Elige tu rol para comenzar.</p>
                        <p id="connection-status" class="text-xs text-gray-500 mt-2"></p>
                    </div>

                    <div class="flex flex-col space-y-4">
                        <button id="player-btn" class="bg-blue-600 hover:bg-blue-700 text-white py-3 px-4 rounded-lg flex items-center justify-center">
                            <i class="fas fa-users mr-2"></i> Soy Jugador
                        </button>

                        <button id="admin-btn" class="bg-gray-600 hover:bg-gray-700 text-white py-3 px-4 rounded-lg flex items-center justify-center">
                            <i class="fas fa-user-cog mr-2"></i> Soy Administrador
                        </button>
                    </div>

                    <div id="admin-login" class="mt-6 hidden">
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="password">
                                Contraseña de Administrador
                            </label>
                            <input id="admin-password" type="password" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="Introduce la contraseña">
                        </div>
                        <div class="flex items-center justify-between">
                            <button id="admin-login-btn" class="bg-red-600 hover:bg-red-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                                Acceder
                            </button>
                            <button id="admin-cancel-btn" class="text-gray-500 hover:text-gray-700">
                                Cancelar
                            </button>
                        </div>
                        <p id="admin-login-status" class="status-message"></p>
                    </div>

                    <div id="player-login" class="mt-6 hidden">
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="game-code">
                                Código de juego
                            </label>
                            <input id="game-code" type="text" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="Introduce el código del juego (RURAL2023)">
                        </div>
                        <div class="mb-4">
                            <label class="block text-gray-700 text-sm font-bold mb-2" for="team-name">
                                Nombre del equipo
                            </label>
                            <input id="team-name" type="text" class="shadow appearance-none border rounded w-full py-2 px-3 text-gray-700 leading-tight focus:outline-none focus:shadow-outline" placeholder="Nombre exacto de tu equipo">
                        </div>
                        <div class="flex items-center justify-between">
                            <button id="team-join-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded focus:outline-none focus:shadow-outline">
                                Unirse al juego
                            </button>
                            <button id="player-cancel-btn" class="text-gray-500 hover:text-gray-700">
                                Cancelar
                            </button>
                        </div>
                         <p id="player-login-status" class="status-message"></p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Admin Dashboard -->
        <div id="admin-dashboard" class="hidden min-h-screen bg-gray-100">
             <nav class="bg-red-800 text-white shadow-lg">
                <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                    <h1 class="title-font text-2xl">Panel de Administrador</h1>
                    <div class="flex items-center">
                        <span id="admin-game-timer" class="mr-4 px-3 py-1 rounded bg-red-900 text-white font-mono">
                            --:--:--
                        </span>
                        <button id="admin-logout-btn" class="bg-red-700 hover:bg-red-600 text-white px-4 py-2 rounded-lg">
                            <i class="fas fa-sign-out-alt"></i> Salir
                        </button>
                    </div>
                </div>
            </nav>

            <div class="container mx-auto p-4">
                 <!-- Game setup section (visible before game starts) -->
                <div id="game-setup" class="mb-8 bg-white rounded-lg shadow-md p-6">
                    <h2 class="text-2xl font-bold mb-4 text-gray-800">Configuración del Juego</h2>
                     <p class="mb-4 text-gray-600">Código Fijo: <strong class="font-mono">RURAL2023</strong></p>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div>
                            <h3 class="text-lg font-semibold mb-3 text-gray-700">Equipos (Mínimo 2, Máximo 6)</h3>
                            <div id="teams-config" class="space-y-3">
                                <div class="flex items-center">
                                    <input type="text" placeholder="Nombre del equipo 1" class="team-name-input flex-grow p-2 border rounded mr-2">
                                    <button class="remove-team text-red-500 hover:text-red-700"><i class="fas fa-times"></i></button>
                                </div>
                                <div class="flex items-center">
                                    <input type="text" placeholder="Nombre del equipo 2" class="team-name-input flex-grow p-2 border rounded mr-2">
                                    <button class="remove-team text-red-500 hover:text-red-700"><i class="fas fa-times"></i></button>
                                </div>
                            </div>
                            <button id="add-team-btn" class="mt-3 bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded">
                                <i class="fas fa-plus mr-2"></i> Añadir equipo
                            </button>
                            <button id="save-teams-btn" class="mt-3 ml-3 bg-green-500 hover:bg-green-600 text-white px-4 py-2 rounded">
                                <i class="fas fa-save mr-2"></i> Guardar Equipos
                            </button>
                            <p id="teams-save-status" class="status-message text-sm"></p>
                        </div>

                        <div>
                            <h3 class="text-lg font-semibold mb-3 text-gray-700">Tiempo de juego</h3>
                            <div class="flex items-center space-x-4">
                                <select id="game-duration" class="p-2 border rounded">
                                    <option value="3600">60 minutos</option>
                                    <option value="4500">75 minutos</option>
                                    <option value="5400" selected>90 minutos</option>
                                    <option value="180">3 minutos (Test)</option> <!-- Added test option -->
                                </select>
                            </div>

                            <div class="mt-6">
                                <button id="start-game-btn" class="w-full bg-green-600 hover:bg-green-700 text-white px-4 py-3 rounded-lg font-bold" disabled>
                                    <i class="fas fa-play mr-2"></i> Iniciar Juego (Guarda equipos primero)
                                </button>
                                <p id="start-game-status" class="status-message text-sm"></p>
                            </div>
                             <div class="mt-6">
                                <button id="reset-game-btn" class="w-full bg-yellow-600 hover:bg-yellow-700 text-white px-4 py-3 rounded-lg font-bold">
                                    <i class="fas fa-undo mr-2"></i> Reiniciar Juego Completo (Borra Todo)
                                </button>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Teams progress section (visible after game starts) -->
                <div id="teams-progress" class="hidden grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                    <!-- Team cards will be generated here -->
                </div>

                 <!-- Game controls section (visible after game starts) -->
                <div id="game-controls" class="hidden mt-6 bg-white rounded-lg shadow-md p-6">
                    <div class="flex flex-col md:flex-row md:justify-between md:items-center">
                         <div>
                            <h2 class="text-2xl font-bold mb-2 text-gray-800">Control del Juego</h2>
                            <p class="text-gray-600">Gestiona el escape room en curso</p>
                        </div>

                        <div class="mt-4 md:mt-0 flex space-x-4">
                            <button id="pause-game-btn" class="bg-yellow-500 hover:bg-yellow-600 text-white px-4 py-2 rounded">
                                <i class="fas fa-pause mr-2"></i> Pausar
                            </button>
                            <button id="end-game-btn" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded">
                                <i class="fas fa-stop mr-2"></i> Finalizar Ahora
                            </button>
                        </div>
                    </div>

                    <div class="mt-6">
                        <h3 class="text-lg font-semibold mb-2 text-gray-700">Enviar pista a todos los equipos</h3>
                        <div class="flex">
                            <input id="global-hint-text" type="text" placeholder="Escribe una pista para todos..." class="flex-grow p-2 border rounded-l">
                            <button id="send-global-hint" class="bg-blue-500 hover:bg-blue-600 text-white px-4 py-2 rounded-r">
                                <i class="fas fa-paper-plane"></i> Enviar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Player Game Screen -->
        <div id="player-screen" class="hidden min-h-screen flex flex-col">
            <!-- Player Top Bar -->
            <div class="bg-blue-800 text-white shadow-md">
                 <div class="container mx-auto px-4 py-3 flex justify-between items-center">
                    <div>
                        <h1 id="player-team-name" class="title-font text-xl">Equipo</h1>
                    </div>
                    <div class="flex items-center">
                         <span id="player-game-timer" class="px-3 py-1 rounded bg-blue-900 text-white font-mono">
                            --:--:--
                        </span>
                    </div>
                </div>
            </div>

             <!-- Notification area -->
            <div id="notification-area" class="hidden bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 relative">
                <button id="close-notification" class="absolute right-2 top-2 text-yellow-700 hover:text-yellow-900">
                    <i class="fas fa-times"></i>
                </button>
                <p id="notification-message"></p>
            </div>

            <!-- Game Content -->
            <div class="flex-grow container mx-auto px-4 py-6">
                <!-- Waiting for Game Start -->
                 <div id="waiting-room" class="bg-white rounded-lg shadow-md p-6 mb-6 text-center">
                    <h2 class="text-2xl font-bold mb-4 title-font text-blue-800">¡Conectado!</h2>
                    <p class="mb-4">Esperando a que el administrador inicie el juego...</p>
                    <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-blue-500 mx-auto"></div>
                </div>

                <!-- Game Introduction (Shown when game starts) -->
                <div id="game-intro" class="hidden bg-white rounded-lg shadow-md p-6 mb-6">
                     <h2 class="text-2xl font-bold mb-4 text-center title-font text-red-800">La Casa Rural Misteriosa</h2>
                    <p class="mb-4">Bienvenidos a esta misteriosa casa rural. Lo que parecía ser una escapada tranquila se ha convertido en un enigma que debéis resolver. Parece que un antiguo secreto se esconde entre estas paredes...</p>
                    <p class="mb-4">Tendréis que resolver 5 pruebas para descubrir el misterio antes de que se agote el tiempo. Cada prueba os dará una pista para resolver el enigma final.</p>
                    <p class="font-bold">¿Estáis preparados para comenzar?</p>
                    <div class="mt-6 text-center">
                        <button id="start-adventure-btn" class="bg-red-700 hover:bg-red-800 text-white px-6 py-3 rounded-lg font-bold">
                            ¡Comenzar la aventura!
                        </button>
                    </div>
                </div>

                <!-- Game Progress -->
                <div id="game-progress" class="hidden mb-6">
                     <div class="bg-white rounded-lg shadow-md p-4">
                        <h3 class="text-lg font-semibold mb-2">Progreso</h3>
                        <div class="w-full bg-gray-200 rounded-full h-4">
                            <div id="progress-bar" class="bg-blue-600 h-4 rounded-full transition-width duration-500" style="width: 0%"></div>
                        </div>
                        <div class="mt-2 flex justify-between text-sm text-gray-600">
                            <span>Prueba 1</span>
                            <span>Prueba 2</span>
                            <span>Prueba 3</span>
                            <span>Prueba 4</span>
                            <span>Prueba 5</span>
                        </div>
                    </div>
                </div>

                 <!-- Hints Section -->
                <div id="hints-section" class="hidden mb-6">
                    <div class="bg-white rounded-lg shadow-md p-4">
                        <div class="flex justify-between items-center mb-2">
                            <h3 class="text-lg font-semibold">Pistas recibidas <span id="hint-count" class="bg-red-600 text-white text-xs px-2 py-1 rounded-full ml-2">0</span></h3>
                            <button id="toggle-hints-btn" class="text-blue-600 hover:text-blue-800">
                                <i class="fas fa-chevron-down"></i>
                            </button>
                        </div>
                        <div id="hints-container" class="hidden space-y-2 mt-2 max-h-40 overflow-y-auto">
                            <p class="text-gray-600 italic text-sm">No hay pistas disponibles todavía...</p>
                        </div>
                    </div>
                </div>

                <!-- Current Challenge Container -->
                <div id="challenge-container" class="hidden">
                    <!-- Challenge content will be inserted here -->
                </div>

                 <!-- Game Completed Message -->
                <div id="game-completed" class="hidden bg-green-100 p-6 rounded-lg text-center">
                    <h2 class="text-2xl font-bold mb-4">¡Enhorabuena! ¡Habéis resuelto todas las pruebas!</h2>
                    <p class="mb-6">Habéis descubierto el secreto de la casa rural: LIBERTAD</p>
                    <p>Esperad a que todos los equipos terminen o a que finalice el tiempo.</p>
                </div>
            </div>
        </div>

        <!-- Game End Screen -->
        <div id="game-end" class="hidden min-h-screen flex items-center justify-center bg-gray-900 bg-opacity-90 fixed inset-0 z-40 p-4">
             <div class="max-w-2xl w-full bg-white rounded-lg shadow-2xl overflow-hidden">
                <div class="p-6 bg-red-800 text-white">
                    <h2 class="title-font text-3xl text-center">¡Fin del juego!</h2>
                </div>
                <div class="p-6">
                    <div id="end-game-message" class="mb-6 text-center text-xl font-bold">
                        <!-- End game message will be displayed here -->
                    </div>

                    <div id="final-rankings" class="mb-6">
                        <h3 class="font-bold text-lg mb-3">Clasificación final:</h3>
                        <div id="rankings-list" class="space-y-2 max-h-60 overflow-y-auto">
                            <!-- Rankings will be displayed here -->
                        </div>
                    </div>

                    <div class="mt-8 text-center">
                         <!-- Botón solo para el admin -->
                         <button id="admin-return-to-setup-btn" class="hidden bg-yellow-600 hover:bg-yellow-700 text-white font-bold py-3 px-6 rounded-lg mr-4">
                            Volver a Configuración
                        </button>
                        <button id="return-to-start-btn" class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-6 rounded-lg">
                            Volver al Inicio (Login)
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- CONFIGURACIÓN DE FIREBASE ---
        // ¡¡¡IMPORTANTE!!! Pega aquí tu objeto firebaseConfig que obtuviste de Firebase
        const firebaseConfig = {
            apiKey: "TU_API_KEY",
            authDomain: "TU_AUTH_DOMAIN",
            databaseURL: "TU_DATABASE_URL", // Asegúrate de que esta URL es correcta
            projectId: "TU_PROJECT_ID",
            storageBucket: "TU_STORAGE_BUCKET",
            messagingSenderId: "TU_MESSAGING_SENDER_ID",
            appId: "TU_APP_ID"
        };

        // --- Inicialización de Firebase ---
        let firebaseApp;
        let db;
        let gameRef; // Referencia a la raíz de los datos de este juego en Firebase
        let dbConnected = false;

        try {
            firebaseApp = firebase.initializeApp(firebaseConfig);
            db = firebase.database();
            gameRef = db.ref('escapeRoomGame/main'); // Usamos una ruta fija para este juego
            console.log("Firebase inicializado.");

            // Comprobar conexión
            const connectedRef = db.ref(".info/connected");
            connectedRef.on("value", (snap) => {
              dbConnected = snap.val() === true;
              console.log("Firebase connected:", dbConnected);
              const statusEl = document.getElementById('connection-status');
              if (statusEl) {
                  statusEl.textContent = dbConnected ? 'Conectado al servidor del juego' : 'Desconectado del servidor';
                  statusEl.className = dbConnected ? 'text-xs text-green-600 mt-2' : 'text-xs text-red-600 mt-2';
              }
               if (!dbConnected) {
                   showNotification("Error de conexión con el servidor del juego. Intenta recargar.", -1); // -1 for permanent
               } else {
                   // Hide permanent error messages if any
                   const notificationArea = document.getElementById('notification-area');
                   if (notificationArea && notificationArea.dataset.permanent === 'true') {
                       notificationArea.classList.add('hidden');
                       delete notificationArea.dataset.permanent;
                   }
               }
            });

        } catch (error) {
            console.error("Error inicializando Firebase:", error);
            alert("Error crítico al inicializar Firebase. Revisa la configuración y la consola.");
            // Ocultar todo y mostrar un error persistente
            document.getElementById('loading-screen').classList.add('hidden');
            document.body.innerHTML = `<div class="min-h-screen flex items-center justify-center bg-red-100 text-red-800 p-4">Error de configuración de Firebase. Revisa la consola (F12).</div>`;
        }


        // --- Variables globales de estado local (mínimas) ---
        let localState = {
            isAdmin: false,
            currentTeamId: null,
            isGameCompletedLocally: false, // Para saber si *este* jugador ha terminado
            timerInterval: null, // Para el intervalo del timer local (solo display)
            listenersAttached: {}, // Para evitar duplicar listeners de Firebase
        };

        // --- Contraseñas y Código Fijo ---
        const ADMIN_PASSWORD = "organizador";
        const FIXED_GAME_CODE = "RURAL2023";

        // --- Definición de Desafíos (sin cambios) ---
        const challenges = [
            { id: 'cipher', title: 'Prueba 1: El Mensaje Cifrado', solution: '3729', hints: ['Observad...', 'Cada letra...', 'El código...'] },
            { id: 'puzzle', title: 'Prueba 2: El Rompecabezas Visual', solution: 'LLAVE', hints: ['Fijaos...', 'La imagen...', 'MAYÚSCULAS'] },
            { id: 'audio', title: 'Prueba 3: El Acertijo Sonoro', solution: '5173', hints: ['Prestad atención...', 'Utilizad Morse...', 'El mensaje...'] },
            { id: 'decision', title: 'Prueba 4: El Laberinto de Decisiones', solution: 'SOTANO', hints: ['Pistas anteriores...', 'Si os equivocáis...', 'Lugar de la casa'] },
            { id: 'final', title: 'Prueba 5: El Enigma Final', solution: 'LIBERTAD', hints: ['Revisad pistas...', 'Letras forman palabra...', '8 letras'] }
        ]; // (Hints acortados para brevedad)


        // --- DOM Elements (Simplificado para claridad) ---
        const elements = {
            loadingScreen: document.getElementById('loading-screen'),
            loadingBar: document.getElementById('loading-bar'),
            loadingText: document.getElementById('loading-text'),
            loginScreen: document.getElementById('login-screen'),
            playerBtn: document.getElementById('player-btn'),
            adminBtn: document.getElementById('admin-btn'),
            adminLogin: document.getElementById('admin-login'),
            playerLogin: document.getElementById('player-login'),
            adminPassword: document.getElementById('admin-password'),
            adminLoginBtn: document.getElementById('admin-login-btn'),
            adminCancelBtn: document.getElementById('admin-cancel-btn'),
            gameCode: document.getElementById('game-code'),
            teamName: document.getElementById('team-name'),
            teamJoinBtn: document.getElementById('team-join-btn'),
            playerCancelBtn: document.getElementById('player-cancel-btn'),
            adminLoginStatus: document.getElementById('admin-login-status'),
            playerLoginStatus: document.getElementById('player-login-status'),
            adminDashboard: document.getElementById('admin-dashboard'),
            playerScreen: document.getElementById('player-screen'),
            waitingRoom: document.getElementById('waiting-room'), // <-- Player waiting room
            gameIntro: document.getElementById('game-intro'),
            startAdventureBtn: document.getElementById('start-adventure-btn'),
            gameProgress: document.getElementById('game-progress'),
            progressBar: document.getElementById('progress-bar'),
            hintsSection: document.getElementById('hints-section'),
            hintCount: document.getElementById('hint-count'),
            toggleHintsBtn: document.getElementById('toggle-hints-btn'),
            hintsContainer: document.getElementById('hints-container'),
            challengeContainer: document.getElementById('challenge-container'),
            gameCompleted: document.getElementById('game-completed'), // <-- Player completed message
            adminGameTimer: document.getElementById('admin-game-timer'),
            playerGameTimer: document.getElementById('player-game-timer'),
            adminLogoutBtn: document.getElementById('admin-logout-btn'),
            gameSetup: document.getElementById('game-setup'),
            teamsConfig: document.getElementById('teams-config'),
            addTeamBtn: document.getElementById('add-team-btn'),
            saveTeamsBtn: document.getElementById('save-teams-btn'), // <-- Save Teams button
            teamsSaveStatus: document.getElementById('teams-save-status'),
            gameDuration: document.getElementById('game-duration'),
            startGameBtn: document.getElementById('start-game-btn'),
            startGameStatus: document.getElementById('start-game-status'),
            resetGameBtn: document.getElementById('reset-game-btn'), // <-- Reset button
            teamsProgress: document.getElementById('teams-progress'),
            gameControls: document.getElementById('game-controls'),
            pauseGameBtn: document.getElementById('pause-game-btn'),
            endGameBtn: document.getElementById('end-game-btn'),
            globalHintText: document.getElementById('global-hint-text'),
            sendGlobalHint: document.getElementById('send-global-hint'),
            playerTeamName: document.getElementById('player-team-name'),
            notificationArea: document.getElementById('notification-area'),
            notificationMessage: document.getElementById('notification-message'),
            closeNotification: document.getElementById('close-notification'),
            gameEnd: document.getElementById('game-end'),
            endGameMessage: document.getElementById('end-game-message'),
            rankingsList: document.getElementById('rankings-list'),
            adminReturnToSetupBtn: document.getElementById('admin-return-to-setup-btn'),
            returnToStartBtn: document.getElementById('return-to-start-btn')
        };

        // --- Utility Functions ---
        function formatTime(totalSeconds) {
            if (isNaN(totalSeconds) || totalSeconds < 0) {
                return "--:--:--";
            }
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const secs = Math.floor(totalSeconds % 60); // Use Math.floor for display
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }

        function showNotification(message, duration = 5000) {
            elements.notificationMessage.textContent = message;
            elements.notificationArea.classList.remove('hidden');
            elements.notificationArea.dataset.permanent = (duration === -1).toString(); // Mark if permanent

            if (elements.notificationArea.timeoutId) {
                clearTimeout(elements.notificationArea.timeoutId);
            }

            if (duration > 0) {
                elements.notificationArea.timeoutId = setTimeout(() => {
                    elements.notificationArea.classList.add('hidden');
                    delete elements.notificationArea.dataset.permanent;
                }, duration);
            }
        }

        // --- Firebase Interaction Functions ---

        // Reset the entire game state in Firebase (USE WITH CAUTION)
        function resetFirebaseGame() {
            if (!localState.isAdmin) return; // Only admin can reset

            if (!confirm("¿Estás SEGURO de que quieres REINICIAR el juego? Esto borrará TODO el progreso y la configuración de equipos de la base de datos.")) {
                return;
            }

            console.log("Reiniciando juego en Firebase...");
            elements.resetGameBtn.disabled = true;
            elements.resetGameBtn.textContent = "Reiniciando...";

            // Define the default clean state
            const defaultGameState = {
                isAdminConnected: false,
                isGameStarted: false,
                isGamePaused: false,
                isGameOver: false, // Added game over flag
                gameDuration: 5400, // Default 90 mins
                gameStartTime: null,
                pauseStartTime: null, // Track when pause started
                totalPausedTime: 0, // Accumulate paused time
                teams: {}, // Empty teams
                globalHints: {}, // Use object for unique keys
                rankings: {} // Store final rankings here
            };

            gameRef.set(defaultGameState)
                .then(() => {
                    console.log("Firebase reseteado con éxito.");
                    showNotification("Juego reiniciado completamente.", 3000);
                    // Go back to admin setup view immediately
                    showAdminDashboard();
                    elements.resetGameBtn.disabled = false;
                    elements.resetGameBtn.innerHTML = '<i class="fas fa-undo mr-2"></i> Reiniciar Juego Completo';
                    elements.startGameBtn.disabled = true; // Need to save teams again
                    elements.startGameBtn.innerHTML = '<i class="fas fa-play mr-2"></i> Iniciar Juego (Guarda equipos primero)';
                    elements.teamsSaveStatus.textContent = "";
                    elements.startGameStatus.textContent = "";
                })
                .catch(error => {
                    console.error("Error reiniciando Firebase:", error);
                    showNotification("Error al reiniciar el juego.", 5000);
                    elements.resetGameBtn.disabled = false;
                     elements.resetGameBtn.innerHTML = '<i class="fas fa-undo mr-2"></i> Reiniciar Juego Completo';
                });
        }


        // Update team configuration in Firebase
        function saveTeamsToFirebase() {
            if (!localState.isAdmin) return;

            const teamInputs = document.querySelectorAll('.team-name-input');
            const teamsData = {};
            let validTeamsCount = 0;
            const teamNames = new Set(); // To check for duplicates

            elements.teamsSaveStatus.textContent = "Guardando...";
            elements.saveTeamsBtn.disabled = true;

            teamInputs.forEach((input, index) => {
                const teamName = input.value.trim();
                if (teamName) {
                     if (teamNames.has(teamName.toLowerCase())) {
                         showNotification(`Nombre de equipo duplicado: "${teamName}". Usa nombres únicos.`, 5000);
                         elements.teamsSaveStatus.textContent = "Error: Nombres duplicados";
                         elements.saveTeamsBtn.disabled = false;
                         throw new Error("Duplicate team name"); // Stop processing
                     }
                    validTeamsCount++;
                    const teamId = `team-${index}`; // Consistent ID based on position
                     teamsData[teamId] = {
                        id: teamId,
                        name: teamName,
                        joined: false,
                        currentChallengeIndex: -1, // -1 means not started adventure yet
                        completedChallenges: {}, // Use object for easier checking
                        startTime: null,
                        endTime: null,
                        hints: {}, // Use object for hints
                        lastHeartbeat: null // Track if player is active (optional)
                    };
                    teamNames.add(teamName.toLowerCase());
                }
            });

             if (validTeamsCount < 2) {
                showNotification('Debes configurar al menos 2 equipos con nombres válidos.', 5000);
                elements.teamsSaveStatus.textContent = "Error: Mínimo 2 equipos";
                elements.saveTeamsBtn.disabled = false;
                return;
            }
             if (validTeamsCount > 6) {
                showNotification('Máximo 6 equipos permitidos.', 5000);
                elements.teamsSaveStatus.textContent = "Error: Máximo 6 equipos";
                 elements.saveTeamsBtn.disabled = false;
                return;
            }

            // Update only the teams node in Firebase
            gameRef.child('teams').set(teamsData)
                .then(() => {
                    console.log("Equipos guardados en Firebase:", teamsData);
                    showNotification("Configuración de equipos guardada.", 3000);
                    elements.teamsSaveStatus.textContent = "Equipos guardados!";
                    elements.saveTeamsBtn.disabled = false;
                    elements.startGameBtn.disabled = false; // Enable start button
                    elements.startGameBtn.innerHTML = '<i class="fas fa-play mr-2"></i> Iniciar Juego';
                })
                .catch(error => {
                    console.error("Error guardando equipos:", error);
                    showNotification("Error al guardar los equipos.", 5000);
                     elements.teamsSaveStatus.textContent = "Error al guardar";
                     elements.saveTeamsBtn.disabled = false;
                });
        }

         // Start the game state in Firebase
        function startGameInFirebase() {
             if (!localState.isAdmin) return;

            elements.startGameBtn.disabled = true;
            elements.startGameStatus.textContent = "Iniciando...";

            const selectedDuration = parseInt(elements.gameDuration.value);

             // Check if teams exist in Firebase before starting
            gameRef.child('teams').once('value', snapshot => {
                const teams = snapshot.val();
                if (!teams || Object.keys(teams).length < 2) {
                    showNotification("Error: Guarda la configuración de equipos antes de iniciar.", 5000);
                    elements.startGameBtn.disabled = false;
                    elements.startGameStatus.textContent = "Error: Guarda equipos";
                    return;
                }

                // Proceed to start the game
                const gameUpdates = {
                    isGameStarted: true,
                    isGamePaused: false,
                    isGameOver: false,
                    gameDuration: selectedDuration,
                    gameStartTime: firebase.database.ServerValue.TIMESTAMP, // Use server time
                    pauseStartTime: null,
                    totalPausedTime: 0,
                    rankings: {} // Clear previous rankings
                };

                gameRef.update(gameUpdates)
                    .then(() => {
                        console.log("Juego iniciado en Firebase.");
                        elements.startGameStatus.textContent = "¡Juego iniciado!";
                        // UI changes handled by listeners
                    })
                    .catch(error => {
                        console.error("Error iniciando juego:", error);
                         showNotification("Error al iniciar el juego.", 5000);
                         elements.startGameBtn.disabled = false; // Re-enable on error
                         elements.startGameStatus.textContent = "Error al iniciar";
                    });
            });
        }

        // Toggle pause state in Firebase
        function togglePauseGameInFirebase() {
            if (!localState.isAdmin) return;

            gameRef.transaction(currentState => {
                if (currentState && currentState.isGameStarted && !currentState.isGameOver) {
                    if (currentState.isGamePaused) {
                        // Resuming
                        const pauseDuration = Date.now() - currentState.pauseStartTime;
                        currentState.totalPausedTime = (currentState.totalPausedTime || 0) + pauseDuration;
                        currentState.isGamePaused = false;
                        currentState.pauseStartTime = null;
                    } else {
                        // Pausing
                        currentState.isGamePaused = true;
                        currentState.pauseStartTime = firebase.database.ServerValue.TIMESTAMP; // Record server time when paused
                    }
                    return currentState;
                }
                 return undefined; // Abort transaction if game not started or already over
            })
            .then(() => console.log("Estado de pausa actualizado"))
            .catch(error => console.error("Error pausando/reanudando:", error));
        }

        // End the game state in Firebase
        function endGameInFirebase() {
            if (!localState.isAdmin) return;

            console.log("Finalizando juego...");
            gameRef.update({ isGameOver: true, isGamePaused: false }) // Set game over flag
                .then(() => console.log("Juego marcado como finalizado en Firebase."))
                .catch(error => console.error("Error finalizando juego:", error));

             // Calculating rankings should happen when isGameOver becomes true, handled by listener
        }

        // Send a global hint via Firebase
        function sendGlobalHintToFirebase() {
            if (!localState.isAdmin) return;
            const hintText = elements.globalHintText.value.trim();
            if (!hintText) return;

             // Push generates a unique key for each hint
            gameRef.child('globalHints').push({
                text: hintText,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            })
            .then(() => {
                console.log("Pista global enviada.");
                elements.globalHintText.value = '';
                showNotification("Pista global enviada a todos.", 2000);
            })
            .catch(error => console.error("Error enviando pista global:", error));
        }

        // Send a hint to a specific team via Firebase
        function sendHintToTeamInFirebase(teamId, hintText) {
            if (!localState.isAdmin || !teamId || !hintText) return;

            gameRef.child(`teams/${teamId}/hints`).push({
                 text: hintText,
                timestamp: firebase.database.ServerValue.TIMESTAMP
            })
            .then(() => {
                console.log(`Pista enviada a ${teamId}.`);
                 showNotification(`Pista enviada al equipo.`, 2000);
                 // Optionally hide the input form in the admin card
                 const card = document.getElementById(`team-card-${teamId}`);
                 if (card) {
                     const form = card.querySelector('.send-hint-form');
                     const input = card.querySelector('.hint-text');
                     if (form) form.classList.add('hidden');
                     if (input) input.value = '';
                 }
            })
            .catch(error => console.error(`Error enviando pista a ${teamId}:`, error));
        }

         // Player joins the game
        function joinGameFirebase() {
            const enteredCode = elements.gameCode.value.trim().toUpperCase();
            const teamNameInput = elements.teamName.value.trim();
            const statusEl = elements.playerLoginStatus;

            statusEl.textContent = "Comprobando...";

            if (enteredCode !== FIXED_GAME_CODE) {
                statusEl.textContent = "Código de juego incorrecto.";
                return;
            }
            if (!teamNameInput) {
                statusEl.textContent = "Introduce el nombre de tu equipo.";
                return;
            }

            gameRef.child('teams').once('value', snapshot => {
                const teams = snapshot.val();
                let foundTeamId = null;
                let teamData = null;

                if (!teams) {
                     statusEl.textContent = "El juego no está configurado aún. Espera al admin.";
                     return;
                }

                for (const teamId in teams) {
                    if (teams[teamId].name.toLowerCase() === teamNameInput.toLowerCase()) {
                        foundTeamId = teamId;
                        teamData = teams[teamId];
                        break;
                    }
                }

                if (!foundTeamId) {
                    statusEl.textContent = "Nombre de equipo no encontrado. Verifica con el admin.";
                    return;
                }

                if (teamData.joined) {
                     statusEl.textContent = "Este equipo ya está jugando en otro dispositivo.";
                     return;
                }

                // Try to mark the team as joined
                const updates = {
                    joined: true,
                    startTime: firebase.database.ServerValue.TIMESTAMP // Record join time
                };
                gameRef.child(`teams/${foundTeamId}`).update(updates)
                    .then(() => {
                        console.log(`Equipo ${foundTeamId} (${teamNameInput}) unido.`);
                        localState.currentTeamId = foundTeamId;
                        showPlayerScreen(teamData.name); // Go to player view
                        listenToGameChanges(); // Start listening to game state for player
                        listenToTeamChanges(foundTeamId); // Start listening to own team changes
                    })
                    .catch(error => {
                        console.error("Error al unirse al equipo:", error);
                        statusEl.textContent = "Error al conectar. Inténtalo de nuevo.";
                    });

            }, error => {
                 console.error("Error leyendo equipos:", error);
                 statusEl.textContent = "Error de conexión al buscar equipos.";
            });
        }

        // Player submits a solution
        function submitSolutionFirebase(challengeId, challengeSolution, userSolution) {
             if (!localState.currentTeamId || localState.isGameCompletedLocally) return;

            const normalizedSolution = userSolution.trim().toUpperCase();
             const correctSolution = challengeSolution.toUpperCase();
             const feedback = document.getElementById('solution-feedback');
             const input = document.getElementById('solution-input');

            if (normalizedSolution === correctSolution) {
                // Correct solution
                showNotification('¡Solución correcta! Avanzando...', 2000);
                if (feedback) feedback.classList.add('hidden');
                if (input) input.classList.remove('border-red-500');

                // Update team progress in Firebase
                const teamRef = gameRef.child(`teams/${localState.currentTeamId}`);
                teamRef.transaction(currentTeamData => {
                    if (currentTeamData) {
                        // Ensure completedChallenges exists and challenge wasn't already completed
                        if (!currentTeamData.completedChallenges) {
                             currentTeamData.completedChallenges = {};
                        }
                        if (!currentTeamData.completedChallenges[challengeId]) {
                            currentTeamData.completedChallenges[challengeId] = true;
                            // Calculate new index based on completed count
                            currentTeamData.currentChallengeIndex = Object.keys(currentTeamData.completedChallenges).length;

                            // Check if this completes the game
                            if (currentTeamData.currentChallengeIndex >= challenges.length) {
                                currentTeamData.endTime = firebase.database.ServerValue.TIMESTAMP;
                            }
                        }
                    }
                    return currentTeamData;
                })
                .then(() => console.log(`Progreso actualizado para ${localState.currentTeamId} - ${challengeId}`))
                .catch(error => console.error("Error actualizando progreso:", error));

                 // UI update for next challenge will be handled by the team listener

            } else {
                // Incorrect solution
                if (feedback) feedback.classList.remove('hidden');
                if (input) {
                    input.classList.add('border-red-500');
                     // Add wiggle animation maybe?
                    input.parentElement.parentElement.parentElement.classList.add('lock-animation'); // Animate the card
                    setTimeout(() => {
                        input.parentElement.parentElement.parentElement.classList.remove('lock-animation');
                        if (feedback) feedback.classList.add('hidden');
                        input.classList.remove('border-red-500');
                    }, 1000);
                }
            }
        }


        // --- Firebase Listeners ---

        // Listen to general game state changes (start, pause, time, end)
        function listenToGameChanges() {
            const gameKeys = ['isGameStarted', 'isGamePaused', 'isGameOver', 'gameDuration', 'gameStartTime', 'totalPausedTime', 'rankings'];

            gameKeys.forEach(key => {
                 // Detach previous listener if exists for this key
                if (localState.listenersAttached[key]) {
                    gameRef.child(key).off('value', localState.listenersAttached[key]);
                }

                const listener = gameRef.child(key).on('value', snapshot => {
                    const value = snapshot.val();
                    console.log(`Firebase update [${key}]:`, value);

                     // Handle specific updates
                     switch (key) {
                        case 'isGameStarted':
                            handleGameStarted(value);
                            break;
                        case 'isGamePaused':
                            handleGamePaused(value);
                            break;
                        case 'isGameOver':
                            handleGameOver(value);
                            break;
                        case 'gameStartTime':
                        case 'gameDuration':
                        case 'totalPausedTime':
                             updateTimerDisplay(); // Recalculate timer display when these change
                             break;
                        case 'rankings':
                            if(localState.isAdmin) {
                                // Admin might update rankings display if game ended while they were viewing
                            }
                            break;
                    }
                }, error => console.error(`Error listening to ${key}:`, error));

                 // Store the listener function to detach later
                localState.listenersAttached[key] = listener;
            });

             // Listen separately for global hints (using child_added for efficiency)
             if (localState.listenersAttached['globalHints']) {
                 gameRef.child('globalHints').off('child_added', localState.listenersAttached['globalHints']);
             }
             localState.listenersAttached['globalHints'] = gameRef.child('globalHints').on('child_added', snapshot => {
                 const hint = snapshot.val();
                 if (hint && !localState.isAdmin && localState.currentTeamId) { // Only show hints to players
                     addHintToUI(hint.text, hint.timestamp);
                 }
             }, error => console.error("Error listening to global hints:", error));
        }

        // Listen to changes for the player's own team
        function listenToTeamChanges(teamId) {
            if (!teamId) return;

            const teamRef = gameRef.child(`teams/${teamId}`);

            // Detach previous listener if exists
            if (localState.listenersAttached['teamData']) {
                 teamRef.off('value', localState.listenersAttached['teamData']);
            }

            localState.listenersAttached['teamData'] = teamRef.on('value', snapshot => {
                const teamData = snapshot.val();
                console.log(`Firebase update [Team ${teamId}]:`, teamData);
                if (!teamData) {
                     // Team data might have been deleted (e.g., admin reset)
                     console.warn(`Team data for ${teamId} not found.`);
                     // Maybe force logout or show error
                     handleLogout(); // Go back to login
                     showNotification("Los datos de tu equipo han desaparecido. Contacta al admin.", -1);
                     return;
                }

                if (localState.isAdmin) {
                    // Admin updates their dashboard card for this team
                    updateAdminTeamCard(teamId, teamData);
                } else if (localState.currentTeamId === teamId) {
                    // Player updates their own screen
                    updatePlayerUI(teamData);
                }

            }, error => console.error(`Error listening to team ${teamId}:`, error));


             // Listen separately for team-specific hints
             const hintsRef = gameRef.child(`teams/${teamId}/hints`);
              if (localState.listenersAttached['teamHints']) {
                 hintsRef.off('child_added', localState.listenersAttached['teamHints']);
             }
            localState.listenersAttached['teamHints'] = hintsRef.on('child_added', snapshot => {
                 const hint = snapshot.val();
                 if (hint && !localState.isAdmin && localState.currentTeamId === teamId) {
                     addHintToUI(hint.text, hint.timestamp);
                 }
             }, error => console.error(`Error listening to team ${teamId} hints:`, error));

        }

        // Detach all Firebase listeners (important on logout/reset)
        function detachAllListeners() {
            console.log("Detaching all Firebase listeners...");
            // Detach game state listeners
            const gameKeys = ['isGameStarted', 'isGamePaused', 'isGameOver', 'gameDuration', 'gameStartTime', 'totalPausedTime', 'rankings'];
            gameKeys.forEach(key => {
                if (localState.listenersAttached[key]) {
                    gameRef.child(key).off('value', localState.listenersAttached[key]);
                }
            });
             if (localState.listenersAttached['globalHints']) {
                 gameRef.child('globalHints').off('child_added', localState.listenersAttached['globalHints']);
             }

             // Detach team listeners (if any were attached)
            if (localState.listenersAttached['teamData'] && localState.currentTeamId) {
                 gameRef.child(`teams/${localState.currentTeamId}`).off('value', localState.listenersAttached['teamData']);
            }
            if (localState.listenersAttached['teamHints'] && localState.currentTeamId) {
                gameRef.child(`teams/${localState.currentTeamId}/hints`).off('child_added', localState.listenersAttached['teamHints']);
            }
             // Detach listeners for admin team view
             if (localState.isAdmin && localState.listenersAttached['adminTeams']) {
                 gameRef.child('teams').off('value', localState.listenersAttached['adminTeams']);
             }

            localState.listenersAttached = {}; // Clear stored listeners
            console.log("Listeners detached.");
        }


        // --- UI Update Functions ---

        function showAdminDashboard() {
            localState.isAdmin = true;
            localState.currentTeamId = null; // Admin doesn't belong to a team
            elements.loginScreen.classList.add('hidden');
            elements.playerScreen.classList.add('hidden');
            elements.gameEnd.classList.add('hidden');
            elements.adminDashboard.classList.remove('hidden');

            // Fetch current game state to setup dashboard correctly
            gameRef.once('value', snapshot => {
                const gameState = snapshot.val() || {}; // Handle case where DB might be empty

                 // Reset team input fields
                elements.teamsConfig.innerHTML = `
                    <div class="flex items-center">
                        <input type="text" placeholder="Nombre del equipo 1" class="team-name-input flex-grow p-2 border rounded mr-2">
                        <button class="remove-team text-red-500 hover:text-red-700"><i class="fas fa-times"></i></button>
                    </div>
                    <div class="flex items-center">
                        <input type="text" placeholder="Nombre del equipo 2" class="team-name-input flex-grow p-2 border rounded mr-2">
                        <button class="remove-team text-red-500 hover:text-red-700"><i class="fas fa-times"></i></button>
                    </div>`;
                addRemoveTeamListeners(); // Re-attach listeners for remove buttons


                if (gameState.isGameStarted && !gameState.isGameOver) {
                    // Game in progress
                    elements.gameSetup.classList.add('hidden');
                    elements.teamsProgress.classList.remove('hidden');
                    elements.gameControls.classList.remove('hidden');
                    generateAdminTeamCards(gameState.teams || {});
                    listenToAdminTeamUpdates(); // Listen for changes to *all* teams
                } else {
                    // Game not started or finished
                    elements.gameSetup.classList.remove('hidden');
                    elements.teamsProgress.classList.add('hidden');
                    elements.gameControls.classList.add('hidden');
                    elements.startGameBtn.disabled = !gameState.teams || Object.keys(gameState.teams).length < 2; // Disable if no teams saved
                    elements.startGameBtn.innerHTML = elements.startGameBtn.disabled
                         ? '<i class="fas fa-play mr-2"></i> Iniciar Juego (Guarda equipos primero)'
                         : '<i class="fas fa-play mr-2"></i> Iniciar Juego';
                    elements.teamsSaveStatus.textContent = "";
                     elements.startGameStatus.textContent = "";
                     // Pre-fill team names if they exist from previous session
                     if (gameState.teams) {
                         elements.teamsConfig.innerHTML = ''; // Clear defaults
                         Object.values(gameState.teams).forEach((team, index) => {
                             addTeamInput(team.name || `Equipo ${index + 1}`);
                         });
                         if (Object.keys(gameState.teams).length < 2) {
                             addTeamInput(); // Add empty inputs if less than 2 teams saved
                             addTeamInput();
                         }
                     }
                }
                // Set duration dropdown
                elements.gameDuration.value = gameState.gameDuration || 5400;
                // Update timer display immediately
                updateTimerDisplay();
            });

            listenToGameChanges(); // Start listening to general game state
        }

         function showPlayerScreen(teamName) {
            localState.isAdmin = false;
            elements.loginScreen.classList.add('hidden');
            elements.adminDashboard.classList.add('hidden');
            elements.gameEnd.classList.add('hidden');
            elements.playerScreen.classList.remove('hidden');
            elements.playerTeamName.textContent = teamName || "Equipo Desconocido";

            // Initial state: Waiting room
            elements.waitingRoom.classList.remove('hidden');
            elements.gameIntro.classList.add('hidden');
            elements.gameProgress.classList.add('hidden');
            elements.hintsSection.classList.add('hidden');
            elements.challengeContainer.classList.add('hidden');
            elements.gameCompleted.classList.add('hidden');

            // Reset hints display
            elements.hintsContainer.innerHTML = '<p class="text-gray-600 italic text-sm">No hay pistas disponibles todavía...</p>';
            elements.hintCount.textContent = '0';

             // Timer display updated by listener
        }

        // --- Game Logic Handlers (Triggered by Firebase Listeners) ---

        function handleGameStarted(isStarted) {
             if (isStarted) {
                 if (!localState.isAdmin && localState.currentTeamId) {
                     // Player sees the intro screen
                     elements.waitingRoom.classList.add('hidden');
                     elements.gameIntro.classList.remove('hidden');
                 } else if (localState.isAdmin) {
                      // Admin sees the progress dashboard
                     elements.gameSetup.classList.add('hidden');
                     elements.teamsProgress.classList.remove('hidden');
                     elements.gameControls.classList.remove('hidden');
                     // Ensure cards are generated and listening
                     gameRef.child('teams').once('value', snapshot => {
                         generateAdminTeamCards(snapshot.val() || {});
                         listenToAdminTeamUpdates();
                     });
                 }
                  startLocalTimer(); // Start updating the display locally
             } else {
                 // Game stopped (or not started) - could be end or reset
                 if (localState.timerInterval) {
                     clearInterval(localState.timerInterval);
                     localState.timerInterval = null;
                 }
                  // Reset timer display? Depends if it's game over or reset
             }
        }

         function handleGamePaused(isPaused) {
             // Update pause button for admin
             if (localState.isAdmin) {
                if (isPaused) {
                    elements.pauseGameBtn.innerHTML = '<i class="fas fa-play mr-2"></i> Reanudar';
                    elements.pauseGameBtn.classList.remove('bg-yellow-500', 'hover:bg-yellow-600');
                    elements.pauseGameBtn.classList.add('bg-green-500', 'hover:bg-green-600');
                } else {
                    elements.pauseGameBtn.innerHTML = '<i class="fas fa-pause mr-2"></i> Pausar';
                    elements.pauseGameBtn.classList.remove('bg-green-500', 'hover:bg-green-600');
                    elements.pauseGameBtn.classList.add('bg-yellow-500', 'hover:bg-yellow-600');
                }
             }
              // Player just sees the timer stop/start via updateTimerDisplay
              updateTimerDisplay(); // Force update to reflect pause state correctly
         }

        function handleGameOver(isOver) {
             if (isOver) {
                 console.log("Game Over detected!");
                 if (localState.timerInterval) {
                     clearInterval(localState.timerInterval);
                     localState.timerInterval = null;
                 }

                 // Calculate rankings (best done once by admin or cloud function, but we'll do it client side for now)
                 gameRef.once('value', snapshot => {
                     const gameState = snapshot.val();
                     if (gameState && gameState.teams) {
                         const finalRankings = calculateRankings(gameState.teams, gameState.gameDuration);

                         // Show end screen for everyone
                         showEndGameScreen(finalRankings);

                         // Admin might want to write rankings back to DB (optional)
                         // gameRef.child('rankings').set(finalRankings);
                     } else {
                          // Show a simpler end screen if data is missing
                          showEndGameScreen([]);
                     }
                 });
             } else {
                 // Game is not over (e.g., after a reset)
                 elements.gameEnd.classList.add('hidden');
             }
        }

        function calculateRankings(teamsData, gameDuration) {
            if (!teamsData) return [];

            return Object.values(teamsData)
                .filter(team => team.joined) // Only include teams that joined
                .map(team => {
                    const completedCount = team.completedChallenges ? Object.keys(team.completedChallenges).length : 0;
                    let timeTaken = gameDuration * 1000; // Default to max time if not finished

                    if (team.endTime && team.startTime) {
                         // Use server timestamps if available
                         timeTaken = team.endTime - team.startTime;
                     } else if (team.startTime) {
                         // If not finished, time is considered max for ranking
                         timeTaken = gameDuration * 1000;
                     } else {
                         // If didn't even start, also max time and 0 challenges
                         timeTaken = gameDuration * 1000;
                     }

                     // Ensure completedCount doesn't exceed challenge count
                    const finalCompletedCount = Math.min(completedCount, challenges.length);


                    return {
                        ...team,
                        completedCount: finalCompletedCount,
                         timeTakenMs: timeTaken
                    };
                })
                .sort((a, b) => {
                    // Sort by challenges completed (descending)
                    if (b.completedCount !== a.completedCount) {
                        return b.completedCount - a.completedCount;
                    }
                    // If same challenges, sort by time taken (ascending)
                     return a.timeTakenMs - b.timeTakenMs;
                });
        }


        // Update player's UI based on their team data from Firebase
        function updatePlayerUI(teamData) {
            if (!teamData || localState.isAdmin) return;

            const currentChallengeIndex = teamData.currentChallengeIndex ?? -1;
            const isAdventureStarted = currentChallengeIndex > -1;
            const isGameCompleted = currentChallengeIndex >= challenges.length;
            localState.isGameCompletedLocally = isGameCompleted; // Update local flag

             // Show/Hide Intro vs. Main Game Area
            if (isAdventureStarted) {
                elements.gameIntro.classList.add('hidden');
                elements.gameProgress.classList.remove('hidden');
                elements.hintsSection.classList.remove('hidden');
                 if (isGameCompleted) {
                    elements.challengeContainer.classList.add('hidden');
                    elements.gameCompleted.classList.remove('hidden');
                 } else {
                     elements.challengeContainer.classList.remove('hidden');
                     elements.gameCompleted.classList.add('hidden');
                      // Load the current challenge content if it's not already loaded or index changed
                     const currentChallengeElement = elements.challengeContainer.querySelector(`[data-challenge-id="${challenges[currentChallengeIndex].id}"]`);
                     if (!currentChallengeElement) {
                        loadChallengeContent(currentChallengeIndex);
                     }
                 }
            } else {
                // Still in intro phase (or waiting room if game hasn't started globally)
                elements.gameProgress.classList.add('hidden');
                elements.hintsSection.classList.add('hidden');
                elements.challengeContainer.classList.add('hidden');
                 elements.gameCompleted.classList.add('hidden');
                 // Check if game intro should be shown (depends on global isGameStarted)
                  gameRef.child('isGameStarted').once('value', snap => {
                      if (snap.val()) {
                         elements.waitingRoom.classList.add('hidden');
                         elements.gameIntro.classList.remove('hidden');
                      } else {
                          elements.waitingRoom.classList.remove('hidden');
                          elements.gameIntro.classList.add('hidden');
                      }
                  });
            }

            // Update Progress Bar
            const progressPercentage = isAdventureStarted ? ((currentChallengeIndex / challenges.length) * 100) : 0;
            elements.progressBar.style.width = `${Math.min(progressPercentage, 100)}%`; // Cap at 100

             // Hints are handled by separate listeners ('child_added')

        }

        // Load the HTML content for a specific challenge
        function loadChallengeContent(challengeIndex) {
             if (challengeIndex < 0 || challengeIndex >= challenges.length) {
                 console.warn("Invalid challenge index:", challengeIndex);
                 elements.challengeContainer.innerHTML = '<p>Error al cargar la prueba.</p>';
                 return;
             }
             const challenge = challenges[challengeIndex];
             console.log("Loading challenge:", challenge.id);

             elements.challengeContainer.innerHTML = `
                <div class="bg-white rounded-lg shadow-md overflow-hidden" data-challenge-id="${challenge.id}">
                    <div class="p-4 bg-blue-700 text-white">
                        <h2 class="text-xl font-bold">${challenge.title}</h2>
                    </div>
                    <div class="p-6">
                        <p class="mb-6">${challenge.description || ""}</p>

                        <div class="challenge-content mb-6">
                            ${getChallengeHTML(challenge.id)}
                        </div>

                        <div class="mt-6">
                            <h3 class="font-bold mb-2">Introduce la solución:</h3>
                            <div class="flex">
                                <input type="text" id="solution-input" class="flex-grow p-2 border rounded-l" placeholder="Solución...">
                                <button id="submit-solution" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-r">
                                    Comprobar
                                </button>
                            </div>
                            <p id="solution-feedback" class="mt-2 text-red-500 hidden">Solución incorrecta. Inténtalo de nuevo.</p>
                        </div>
                    </div>
                </div>
            `;

            // Add event listeners for the new challenge content
            setupChallengeInteractionListeners(challenge);
        }

        // Add interaction listeners for specific challenge types
        function setupChallengeInteractionListeners(challenge) {
            const submitButton = document.getElementById('submit-solution');
             const solutionInput = document.getElementById('solution-input');

            if (submitButton && solutionInput) {
                submitButton.addEventListener('click', () => {
                    submitSolutionFirebase(challenge.id, challenge.solution, solutionInput.value);
                });
                 // Allow Enter key submission
                solutionInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                         submitSolutionFirebase(challenge.id, challenge.solution, solutionInput.value);
                    }
                });
            }

             // Add challenge-specific listeners (reuse existing functions)
            if (challenge.id === 'puzzle') {
                setupPuzzleListeners();
            } else if (challenge.id === 'audio') {
                setupAudioListeners();
            } else if (challenge.id === 'decision') {
                setupDecisionListeners();
            } else if (challenge.id === 'final') {
                setupFinalListeners();
            }
        }

        // --- Timer Logic ---

        function startLocalTimer() {
             if (localState.timerInterval) clearInterval(localState.timerInterval); // Clear existing interval

             localState.timerInterval = setInterval(() => {
                 updateTimerDisplay();
             }, 1000);
        }

        function updateTimerDisplay() {
             gameRef.once('value', snapshot => {
                const gameState = snapshot.val();
                if (!gameState || !gameState.isGameStarted || gameState.isGameOver) {
                    // Game not running or finished
                    const displayTime = gameState?.isGameOver ? "00:00:00" : "--:--:--";
                    if (elements.adminGameTimer) elements.adminGameTimer.textContent = displayTime;
                    if (elements.playerGameTimer) elements.playerGameTimer.textContent = displayTime;
                     if (elements.adminGameTimer) elements.adminGameTimer.classList.remove('timer-warning');
                     if (elements.playerGameTimer) elements.playerGameTimer.classList.remove('timer-warning');
                     if (localState.timerInterval && gameState?.isGameOver) {
                         clearInterval(localState.timerInterval); // Stop timer if game ended
                         localState.timerInterval = null;
                     }
                    return;
                }

                if (gameState.isGamePaused) {
                     // Show paused time or just "--:--:--" maybe? Let's show last calculated time
                     const pausedTime = calculateRemainingSeconds(gameState);
                     const displayTime = formatTime(pausedTime);
                     if (elements.adminGameTimer) elements.adminGameTimer.textContent = `${displayTime} (Pausado)`;
                     if (elements.playerGameTimer) elements.playerGameTimer.textContent = `${displayTime} (Pausado)`;
                     return; // Don't continue countdown while paused
                }

                 const remainingSeconds = calculateRemainingSeconds(gameState);

                 if (remainingSeconds <= 0) {
                    // Time's up!
                     if (elements.adminGameTimer) elements.adminGameTimer.textContent = "00:00:00";
                     if (elements.playerGameTimer) elements.playerGameTimer.textContent = "00:00:00";
                     if (localState.isAdmin) {
                        // Only admin triggers the game end based on time
                        endGameInFirebase();
                     }
                     if (localState.timerInterval) {
                        clearInterval(localState.timerInterval); // Stop the local interval
                        localState.timerInterval = null;
                     }
                 } else {
                     const displayTime = formatTime(remainingSeconds);
                     if (elements.adminGameTimer) elements.adminGameTimer.textContent = displayTime;
                     if (elements.playerGameTimer) elements.playerGameTimer.textContent = displayTime;

                     // Add warning class if time is low
                     const warningClass = 'timer-warning';
                      if (remainingSeconds <= 300) {
                          if (elements.adminGameTimer) elements.adminGameTimer.classList.add(warningClass);
                          if (elements.playerGameTimer) elements.playerGameTimer.classList.add(warningClass);
                      } else {
                           if (elements.adminGameTimer) elements.adminGameTimer.classList.remove(warningClass);
                           if (elements.playerGameTimer) elements.playerGameTimer.classList.remove(warningClass);
                      }
                 }
             });
        }

        function calculateRemainingSeconds(gameState) {
             if (!gameState || !gameState.isGameStarted || !gameState.gameStartTime) {
                return gameState?.gameDuration || 0; // Return full duration if not started
             }

            const now = Date.now();
            const startTime = gameState.gameStartTime;
            const durationSec = gameState.gameDuration;
            const totalPausedMs = gameState.totalPausedTime || 0;

            let elapsedMs;
            if (gameState.isGamePaused && gameState.pauseStartTime) {
                // If currently paused, elapsed time is up to the pause start time
                 elapsedMs = gameState.pauseStartTime - startTime - totalPausedMs;
             } else {
                  // If running, elapsed time is now - start - total paused duration
                 elapsedMs = now - startTime - totalPausedMs;
             }

            const elapsedSec = Math.floor(elapsedMs / 1000);
            const remainingSec = durationSec - elapsedSec;

            return Math.max(0, remainingSec); // Ensure it doesn't go below zero
        }


         // --- Admin Dashboard UI ---

         function addTeamInput(teamName = '') {
            const teamInputs = document.querySelectorAll('.team-name-input');
            if (teamInputs.length >= 6) {
                showNotification('Máximo 6 equipos permitidos', 3000);
                return;
            }

            const teamDiv = document.createElement('div');
            teamDiv.className = 'flex items-center mt-2'; // Added mt-2 for spacing
            teamDiv.innerHTML = `
                <input type="text" value="${escapeHtml(teamName)}" placeholder="Nombre del equipo ${teamInputs.length + 1}" class="team-name-input flex-grow p-2 border rounded mr-2">
                <button class="remove-team text-red-500 hover:text-red-700">
                    <i class="fas fa-times"></i>
                </button>
            `;
            elements.teamsConfig.appendChild(teamDiv);
            addRemoveTeamListeners(); // Re-attach listeners
        }
         // Helper to prevent XSS if team names have special chars
        function escapeHtml(unsafe) {
            if (!unsafe) return "";
            return unsafe
                 .replace(/&/g, "&amp;")
                 .replace(/</g, "&lt;")
                 .replace(/>/g, "&gt;")
                 .replace(/"/g, "&quot;")
                 .replace(/'/g, "&#039;");
        }


        function addRemoveTeamListeners() {
            document.querySelectorAll('.remove-team').forEach(btn => {
                // Remove previous listener to avoid duplicates if function is called multiple times
                 btn.replaceWith(btn.cloneNode(true));
            });
            document.querySelectorAll('.remove-team').forEach(btn => {
                btn.addEventListener('click', function() {
                    if (document.querySelectorAll('.team-name-input').length > 2) {
                        this.parentElement.remove();
                    } else {
                        showNotification('Debes tener al menos 2 equipos', 3000);
                    }
                });
            });
        }

         // Listen for updates to any team data for the admin dashboard
        function listenToAdminTeamUpdates() {
             // Detach previous listener if exists
            if (localState.listenersAttached['adminTeams']) {
                gameRef.child('teams').off('value', localState.listenersAttached['adminTeams']);
            }

            localState.listenersAttached['adminTeams'] = gameRef.child('teams').on('value', snapshot => {
                const teamsData = snapshot.val() || {};
                 console.log("Admin received team updates:", teamsData);
                 // Re-generate cards to reflect all changes (simpler than partial updates)
                 generateAdminTeamCards(teamsData);
            }, error => console.error("Error listening to all teams (admin):", error));
        }


        function generateAdminTeamCards(teamsData) {
            elements.teamsProgress.innerHTML = ''; // Clear existing cards
            if (!teamsData || Object.keys(teamsData).length === 0) {
                 elements.teamsProgress.innerHTML = '<p class="text-gray-600 italic col-span-full text-center">No hay equipos configurados o el juego no ha comenzado.</p>';
                 return;
            }

            Object.entries(teamsData).forEach(([teamId, team]) => {
                const card = document.createElement('div');
                card.className = 'bg-white rounded-lg shadow-md overflow-hidden team-card';
                card.id = `team-card-${teamId}`;

                const completedCount = team.completedChallenges ? Object.keys(team.completedChallenges).length : 0;
                const progress = Math.min(100, (completedCount / challenges.length) * 100);
                const currentChallengeIndex = team.currentChallengeIndex ?? -1;
                 let challengeText = "-";
                 if (currentChallengeIndex === -1) {
                     challengeText = team.joined ? "Esperando inicio aventura" : "No iniciado";
                 } else if (currentChallengeIndex >= challenges.length) {
                     challengeText = "¡Completado!";
                 } else {
                      challengeText = `Prueba ${currentChallengeIndex + 1}`; // Show next challenge number
                 }

                 // Calculate elapsed time if started
                let timeText = "--:--:--";
                if (team.startTime) {
                     const now = Date.now();
                     let elapsedMs;
                     if (team.endTime) {
                         elapsedMs = team.endTime - team.startTime;
                     } else {
                         // Get global pause state to calculate active time
                          gameRef.once('value', snap => { // Need to fetch global state here
                             const gameState = snap.val();
                             let currentTotalPaused = gameState?.totalPausedTime || 0;
                             if (gameState?.isGamePaused && gameState.pauseStartTime) {
                                 // Add time paused *since* the last stored totalPausedTime up to now
                                 currentTotalPaused += (now - gameState.pauseStartTime);
                             }
                             elapsedMs = now - team.startTime - currentTotalPaused;
                          });

                         // Fallback if gameRef read fails quickly
                         if (typeof elapsedMs === 'undefined') {
                             elapsedMs = now - team.startTime; // Approximation without pause
                         }
                     }
                     timeText = formatTime(Math.max(0, Math.floor(elapsedMs / 1000)));
                }


                card.innerHTML = `
                    <div class="p-4 ${team.joined ? 'bg-blue-700' : 'bg-gray-500'} text-white">
                        <h3 class="font-bold text-lg">${escapeHtml(team.name)}</h3>
                        <div class="text-sm mt-1">
                            <span class="team-status px-2 py-0.5 rounded text-xs ${team.joined ? 'bg-green-500' : 'bg-gray-700'}">
                                ${team.joined ? 'Conectado' : 'Esperando...'}
                            </span>
                        </div>
                    </div>
                    <div class="p-4">
                        <div class="mb-3">
                            <div class="text-sm text-gray-500 mb-1">Progreso (${completedCount}/${challenges.length})</div>
                            <div class="w-full bg-gray-200 rounded-full h-2.5">
                                <div class="team-progress bg-blue-600 h-2.5 rounded-full" style="width: ${progress}%"></div>
                            </div>
                        </div>
                        <div class="mb-3">
                            <div class="text-sm text-gray-500 mb-1">Estado Actual</div>
                            <div class="team-challenge font-medium">${challengeText}</div>
                        </div>
                        <div class="mt-4">
                            <div class="flex justify-between items-center">
                                <button class="send-hint-btn bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded text-sm ${currentChallengeIndex >= challenges.length ? 'opacity-50 cursor-not-allowed' : ''}" ${currentChallengeIndex >= challenges.length ? 'disabled' : ''}>
                                    <i class="fas fa-lightbulb mr-1"></i> Enviar pista
                                </button>
                                <span class="team-time text-sm font-mono">${timeText}</span>
                            </div>
                            <div class="send-hint-form hidden mt-2">
                                <div class="flex">
                                    <input type="text" placeholder="Escribe una pista..." class="hint-text flex-grow p-1 text-sm border rounded-l">
                                    <button class="confirm-hint-btn bg-green-500 hover:bg-green-600 text-white px-2 py-1 rounded-r text-sm">
                                        <i class="fas fa-check"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                elements.teamsProgress.appendChild(card);

                 // Add event listeners for hint buttons on this specific card
                const sendHintBtn = card.querySelector('.send-hint-btn');
                const sendHintForm = card.querySelector('.send-hint-form');
                const confirmHintBtn = card.querySelector('.confirm-hint-btn');
                const hintText = card.querySelector('.hint-text');

                if (sendHintBtn && !sendHintBtn.disabled) {
                    sendHintBtn.addEventListener('click', () => {
                        sendHintForm.classList.toggle('hidden');
                        if (!sendHintForm.classList.contains('hidden')) {
                            hintText.focus();
                        }
                    });
                }
                if (confirmHintBtn) {
                    confirmHintBtn.addEventListener('click', () => {
                        const hint = hintText.value.trim();
                        if (hint) {
                             sendHintToTeamInFirebase(teamId, hint);
                             // Hiding the form is handled by the success callback now
                        }
                    });
                }
            });
        }

         // Update a specific team card in the admin dashboard (called by listener)
         function updateAdminTeamCard(teamId, teamData) {
            const card = document.getElementById(`team-card-${teamId}`);
            if (!card || !teamData) return; // Card might not exist if admin joined mid-game

            const statusEl = card.querySelector('.team-status');
            const progressEl = card.querySelector('.team-progress');
            const challengeEl = card.querySelector('.team-challenge');
            const timeEl = card.querySelector('.team-time');
            const sendHintBtn = card.querySelector('.send-hint-btn');

             // Status
             if (statusEl) {
                statusEl.textContent = teamData.joined ? 'Conectado' : 'Esperando...';
                statusEl.className = `team-status px-2 py-0.5 rounded text-xs ${teamData.joined ? 'bg-green-500' : 'bg-gray-700'}`;
                const bgDiv = card.querySelector('div:first-child'); // First div for background color
                 if (bgDiv) {
                     bgDiv.className = `p-4 ${teamData.joined ? 'bg-blue-700' : 'bg-gray-500'} text-white`;
                 }
             }

            // Progress
            const completedCount = teamData.completedChallenges ? Object.keys(teamData.completedChallenges).length : 0;
            const progress = Math.min(100, (completedCount / challenges.length) * 100);
             if (progressEl) {
                progressEl.style.width = `${progress}%`;
                // Update text in parent div
                 const progressTextDiv = progressEl.closest('.mb-3').querySelector('.text-sm');
                 if(progressTextDiv) progressTextDiv.textContent = `Progreso (${completedCount}/${challenges.length})`;
             }


            // Challenge State
             const currentChallengeIndex = teamData.currentChallengeIndex ?? -1;
             let challengeText = "-";
             if (currentChallengeIndex === -1) {
                 challengeText = teamData.joined ? "Esperando inicio aventura" : "No iniciado";
             } else if (currentChallengeIndex >= challenges.length) {
                 challengeText = "¡Completado!";
             } else {
                 challengeText = `Prueba ${currentChallengeIndex + 1}`;
             }
             if (challengeEl) challengeEl.textContent = challengeText;

             // Disable hint button if completed
            if (sendHintBtn) {
                 const isDisabled = currentChallengeIndex >= challenges.length;
                 sendHintBtn.disabled = isDisabled;
                 sendHintBtn.classList.toggle('opacity-50', isDisabled);
                 sendHintBtn.classList.toggle('cursor-not-allowed', isDisabled);
             }


             // Time
             if (timeEl && teamData.startTime) {
                 const now = Date.now();
                  let elapsedMs;
                 if (teamData.endTime) {
                     elapsedMs = teamData.endTime - teamData.startTime;
                 } else {
                     // Fetch global state async to calculate accurately
                     gameRef.once('value').then(snap => {
                         const gameState = snap.val();
                         let currentTotalPaused = gameState?.totalPausedTime || 0;
                         if (gameState?.isGamePaused && gameState.pauseStartTime) {
                            currentTotalPaused += (now - gameState.pauseStartTime);
                         }
                         elapsedMs = now - teamData.startTime - currentTotalPaused;
                         timeEl.textContent = formatTime(Math.max(0, Math.floor(elapsedMs / 1000)));
                     }).catch(() => {
                          // Fallback on error
                          elapsedMs = now - teamData.startTime;
                          timeEl.textContent = formatTime(Math.max(0, Math.floor(elapsedMs / 1000)));
                     });
                      // Initial quick update (might be slightly off if paused)
                     elapsedMs = now - teamData.startTime - (teamData.totalPausedTime || 0);
                      timeEl.textContent = formatTime(Math.max(0, Math.floor(elapsedMs / 1000)));

                 }

             } else if (timeEl) {
                 timeEl.textContent = "--:--:--";
             }
        }


        // --- Player UI Functions ---

        function addHintToUI(hintText, timestamp) {
             if (localState.isAdmin) return; // Don't show hints to admin here

             const hintElement = document.createElement('div');
             hintElement.className = 'p-2 bg-yellow-100 rounded border-l-4 border-yellow-400 animate-pulse-once'; // Add animation class

            const timeStr = timestamp ? new Date(timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';
            hintElement.innerHTML = `
                <div class="flex justify-between items-start">
                    <p class="text-gray-800">${escapeHtml(hintText)}</p>
                    <span class="text-xs text-gray-500 ml-2 flex-shrink-0">${timeStr}</span>
                </div>
            `;

            // Remove placeholder if it exists
             const placeholder = elements.hintsContainer.querySelector('p.italic');
             if (placeholder) {
                 elements.hintsContainer.removeChild(placeholder);
             }

            // Add hint to the top
            elements.hintsContainer.insertBefore(hintElement, elements.hintsContainer.firstChild);

            // Update hint count badge
             const currentCount = parseInt(elements.hintCount.textContent || '0');
             elements.hintCount.textContent = currentCount + 1;

            // Briefly highlight the hint section or show notification
            showNotification('¡Has recibido una nueva pista!', 3000);
             elements.hintsSection.classList.add('ring-2', 'ring-yellow-400');
             setTimeout(() => {
                 elements.hintsSection.classList.remove('ring-2', 'ring-yellow-400');
                 hintElement.classList.remove('animate-pulse-once'); // Remove animation after a bit
             }, 2000);

              // Auto-open hint section if closed
             if (elements.hintsContainer.classList.contains('hidden')) {
                 elements.toggleHintsBtn.click();
             }
        }


        // --- Game End Screen ---
        function showEndGameScreen(rankings) {
             console.log("Showing end game screen with rankings:", rankings);
            // Hide other screens
            elements.adminDashboard.classList.add('hidden');
            elements.playerScreen.classList.add('hidden');
            elements.loginScreen.classList.add('hidden'); // Hide login too

            // Show end game screen overlay
            elements.gameEnd.classList.remove('hidden');

            // Set winner message
            if (rankings && rankings.length > 0) {
                 const winner = rankings[0];
                 elements.endGameMessage.textContent = `El equipo ganador es: ${escapeHtml(winner.name)}!`;
            } else {
                 elements.endGameMessage.textContent = "El juego ha terminado.";
            }

            // Generate rankings list
            elements.rankingsList.innerHTML = ''; // Clear previous list
             if (rankings && rankings.length > 0) {
                rankings.forEach((team, index) => {
                    const rankItem = document.createElement('div');
                    rankItem.className = 'flex justify-between items-center p-3 bg-gray-50 rounded border mb-2';

                    const position = index + 1;
                    const medal = position === 1 ? '🥇' : position === 2 ? '🥈' : position === 3 ? '🥉' : `<span class="font-bold mr-1">${position}.</span>`;

                     const challengesText = team.completedCount === challenges.length ?
                        'Todas las pruebas' :
                        `${team.completedCount} de ${challenges.length} pruebas`;

                     const time = formatTime(Math.floor(team.timeTakenMs / 1000));

                    rankItem.innerHTML = `
                        <div class="flex items-center">
                            <span class="text-xl w-8 text-center mr-2">${medal}</span>
                            <span class="font-semibold">${escapeHtml(team.name)}</span>
                        </div>
                        <div class="text-right text-sm">
                            <div class="text-gray-700">${challengesText}</div>
                            <div class="font-mono text-gray-900">${time}</div>
                        </div>
                    `;
                    elements.rankingsList.appendChild(rankItem);
                });
             } else {
                 elements.rankingsList.innerHTML = '<p class="text-center text-gray-600 italic">No hay datos de clasificación disponibles.</p>';
             }

             // Show admin-specific button if admin
             if (localState.isAdmin) {
                 elements.adminReturnToSetupBtn.classList.remove('hidden');
             } else {
                  elements.adminReturnToSetupBtn.classList.add('hidden');
             }
        }


        // --- Event Listener Setup ---
        function setupEventListeners() {
            // Login screen buttons
            elements.playerBtn.addEventListener('click', () => {
                elements.adminLogin.classList.add('hidden');
                elements.playerLogin.classList.remove('hidden');
                elements.playerLoginStatus.textContent = ''; // Clear status
            });
            elements.adminBtn.addEventListener('click', () => {
                elements.playerLogin.classList.add('hidden');
                elements.adminLogin.classList.remove('hidden');
                 elements.adminLoginStatus.textContent = ''; // Clear status
            });
            elements.adminCancelBtn.addEventListener('click', () => {
                elements.adminLogin.classList.add('hidden');
                elements.adminPassword.value = '';
            });
            elements.playerCancelBtn.addEventListener('click', () => {
                elements.playerLogin.classList.add('hidden');
                elements.gameCode.value = '';
                elements.teamName.value = '';
            });

            // Logins
            elements.adminLoginBtn.addEventListener('click', handleAdminLogin);
            elements.teamJoinBtn.addEventListener('click', joinGameFirebase); // Use Firebase join

            // Admin logout
            elements.adminLogoutBtn.addEventListener('click', handleLogout);

            // Admin game setup/control
            elements.addTeamBtn.addEventListener('click', () => addTeamInput());
             elements.saveTeamsBtn.addEventListener('click', saveTeamsToFirebase); // Save teams
            elements.startGameBtn.addEventListener('click', startGameInFirebase); // Start game
            elements.resetGameBtn.addEventListener('click', resetFirebaseGame); // Reset game
            elements.pauseGameBtn.addEventListener('click', togglePauseGameInFirebase); // Pause game
            elements.endGameBtn.addEventListener('click', endGameInFirebase); // End game
            elements.sendGlobalHint.addEventListener('click', sendGlobalHintToFirebase); // Send global hint

            // Player game actions
            elements.startAdventureBtn.addEventListener('click', startPlayerAdventure);
            elements.toggleHintsBtn.addEventListener('click', () => {
                elements.hintsContainer.classList.toggle('hidden');
                const icon = elements.toggleHintsBtn.querySelector('i');
                icon.classList.toggle('fa-chevron-down');
                icon.classList.toggle('fa-chevron-up');
            });
             elements.closeNotification.addEventListener('click', () => {
                 elements.notificationArea.classList.add('hidden');
                 delete elements.notificationArea.dataset.permanent; // Clear permanent flag
             });

            // Game End Screen Buttons
            elements.returnToStartBtn.addEventListener('click', handleLogout); // Go back to login screen
             elements.adminReturnToSetupBtn.addEventListener('click', () => { // Admin goes back to setup
                 if (localState.isAdmin) {
                      elements.gameEnd.classList.add('hidden'); // Hide end screen first
                      showAdminDashboard(); // Show the admin dashboard (will fetch state)
                 }
             });

            // Initial setup for remove buttons on default team inputs
            addRemoveTeamListeners();
        }

         function handleAdminLogin() {
             const password = elements.adminPassword.value;
             const statusEl = elements.adminLoginStatus;
             statusEl.textContent = '';

             if (password === ADMIN_PASSWORD) {
                 console.log("Admin login successful");
                 // Mark admin as connected in Firebase (optional, but useful)
                 gameRef.child('isAdminConnected').set(true);
                 showAdminDashboard();
             } else {
                 statusEl.textContent = "Contraseña incorrecta.";
             }
         }

         function handleLogout() {
             console.log("Handling logout...");
             // Detach all Firebase listeners to prevent updates in the background
             detachAllListeners();

              // If admin was logged in, mark as disconnected in Firebase
             if (localState.isAdmin) {
                 gameRef.child('isAdminConnected').set(false);
             }
              // If player was logged in, mark team as not joined? Or just leave it?
              // Let's leave 'joined' as true to prevent re-joining easily,
              // but maybe clear their heartbeat if implemented.

              // Reset local state
             localState.isAdmin = false;
             localState.currentTeamId = null;
             localState.isGameCompletedLocally = false;
             if (localState.timerInterval) {
                 clearInterval(localState.timerInterval);
                 localState.timerInterval = null;
             }

             // Reset UI to login screen
             elements.adminDashboard.classList.add('hidden');
             elements.playerScreen.classList.add('hidden');
             elements.gameEnd.classList.add('hidden');
             elements.loginScreen.classList.remove('hidden');

             // Clear login fields and status messages
             elements.adminPassword.value = '';
             elements.gameCode.value = '';
             elements.teamName.value = '';
             elements.adminLoginStatus.textContent = '';
             elements.playerLoginStatus.textContent = '';
              elements.adminGameTimer.textContent = "--:--:--";
             elements.playerGameTimer.textContent = "--:--:--";
              elements.notificationArea.classList.add('hidden'); // Hide any leftover notifications
         }

         function startPlayerAdventure() {
             if (!localState.currentTeamId) return;

             // Mark that the player has started the adventure in Firebase
             const teamRef = gameRef.child(`teams/${localState.currentTeamId}`);
             teamRef.transaction(currentTeamData => {
                 if (currentTeamData && currentTeamData.currentChallengeIndex === -1) {
                      currentTeamData.currentChallengeIndex = 0; // Start at first challenge (index 0)
                 }
                 return currentTeamData;
             })
             .then(() => console.log(`Player ${localState.currentTeamId} started adventure.`))
             .catch(error => console.error("Error starting player adventure:", error));

              // The UI update (hiding intro, showing progress/challenge)
              // will be handled by the team listener reacting to the change
              // in currentChallengeIndex.
         }


        // --- Initialization ---
        function initGame() {
             console.log("Initializing game...");
             // Simulate loading while Firebase connects
             let progress = 0;
             const loadingInterval = setInterval(() => {
                progress += 10;
                elements.loadingBar.style.width = `${progress}%`;

                if (progress >= 50) elements.loadingText.textContent = 'Estableciendo conexión...';

                if (dbConnected || progress >= 100) { // Wait for connection or timeout
                    clearInterval(loadingInterval);
                     elements.loadingBar.style.width = `100%`;
                     elements.loadingText.textContent = dbConnected ? '¡Conectado!' : 'Error de conexión inicial.';
                     setTimeout(() => {
                        elements.loadingScreen.classList.add('hidden');
                        if (dbConnected) {
                            elements.loginScreen.classList.remove('hidden');
                        } else {
                             // Show persistent error if connection failed initially
                             showNotification("No se pudo conectar al servidor del juego. Revisa tu conexión o la configuración de Firebase e inténtalo de nuevo.", -1);
                              // Maybe disable login buttons?
                              elements.playerBtn.disabled = true;
                              elements.adminBtn.disabled = true;
                        }
                    }, 500);
                }
             }, 150);

            setupEventListeners();
        }

        // --- Challenge Specific HTML and Listeners (Reusing previous code) ---
        // getChallengeHTML, setupPuzzleListeners, checkPuzzleSolution,
        // setupAudioListeners, formatAudioTime, setupDecisionListeners, setupFinalListeners
        // (These functions don't need significant changes as they mainly deal with local UI interaction)

        function getChallengeHTML(challengeId) {
            // Return the inner HTML for the specific challenge (same as original code)
             switch (challengeId) {
                case 'cipher': return `... (Contenido HTML de cipher) ...`;
                case 'puzzle': return `... (Contenido HTML de puzzle) ...`;
                case 'audio': return `... (Contenido HTML de audio) ...`;
                case 'decision': return `... (Contenido HTML de decision) ...`;
                case 'final': return `... (Contenido HTML de final) ...`;
                default: return '<p>Contenido no disponible</p>';
            }
             // *** ¡¡¡ COPIA Y PEGA AQUÍ EL CONTENIDO HTML DE CADA getChallengeContent(...) DE TU CÓDIGO ORIGINAL !!! ***
             // Ejemplo para 'cipher':
             /*
             case 'cipher':
                 return `
                     <div class="bg-gray-100 p-4 rounded-lg mb-4">
                         <h3 class="font-bold mb-2">Mensaje cifrado:</h3>
                         <p class="font-mono text-lg">19-8 ... </p>
                     </div>
                     <div class="bg-gray-100 p-4 rounded-lg">
                         <h3 class="font-bold mb-2">Tabla de cifrado:</h3>
                         <table class="cipher-table w-full"> ... </table>
                     </div>
                 `;
             */
        }

        function setupPuzzleListeners() { /* ... Mismo código que antes ... */ }
        function checkPuzzleSolution() { /* ... Mismo código que antes ... */ }
        function setupAudioListeners() { /* ... Mismo código que antes ... */ }
        function formatAudioTime(seconds) { /* ... Mismo código que antes ... */ }
        function setupDecisionListeners() { /* ... Mismo código que antes ... */ }
        function setupFinalListeners() { /* ... Mismo código que antes ... */ }
         function shuffleArray(array) { /* ... Mismo código que antes ... */ } // Ensure this helper is present


        // --- Start Everything ---
        // Ensure Firebase is ready before starting the game UI logic
        const checkFirebaseReady = setInterval(() => {
            if (typeof firebase !== 'undefined' && typeof db !== 'undefined') {
                clearInterval(checkFirebaseReady);
                initGame();
            } else if (typeof firebase === 'undefined') {
                 // Firebase SDK failed to load entirely
                 clearInterval(checkFirebaseReady);
                 console.error("Firebase SDK no se cargó.");
                  document.getElementById('loading-screen').classList.add('hidden');
                  document.body.innerHTML = `<div class="min-h-screen flex items-center justify-center bg-red-100 text-red-800 p-4">Error: No se pudo cargar el SDK de Firebase. Revisa la conexión a internet o los bloqueadores de scripts.</div>`;
            }
        }, 100);

    </script>

     <!-- Copia aquí las funciones JS de interacción de los puzzles del código original -->
     <!-- Necesitarás: setupPuzzleListeners, checkPuzzleSolution, setupAudioListeners, -->
     <!-- formatAudioTime, setupDecisionListeners, setupFinalListeners, shuffleArray -->
     <script>
        // Pega aquí las funciones JS que faltan (setupPuzzleListeners, etc.)
        // Ejemplo:
        function setupPuzzleListeners() {
            const puzzlePieces = document.querySelectorAll('.puzzle-piece');
            const shuffleButton = document.getElementById('shuffle-puzzle');
            const puzzleGrid = document.getElementById('puzzle-grid'); // Needed for completion message
            let selectedPiece = null;

             // Check if elements exist before adding listeners
            if (!puzzlePieces.length || !puzzleGrid) return;

            puzzlePieces.forEach(piece => {
                piece.addEventListener('click', () => {
                    if (localState.isGameCompletedLocally) return; // Don't allow interaction if game completed

                    if (selectedPiece === null) {
                        selectedPiece = piece;
                        piece.classList.add('ring-2', 'ring-blue-500');
                    } else if (selectedPiece === piece) {
                         // Deselect if clicking the same piece
                         selectedPiece.classList.remove('ring-2', 'ring-blue-500');
                         selectedPiece = null;
                    }
                     else {
                        // Swap pieces - visually only for now, logic tied to checkPuzzleSolution
                         const targetNode = piece;
                         const sourceNode = selectedPiece;

                         // Swap positions in the DOM
                         const parent = sourceNode.parentNode;
                         const targetNextSibling = targetNode.nextSibling === sourceNode ? targetNode : targetNode.nextSibling;

                         parent.insertBefore(sourceNode, targetNextSibling);
                         parent.insertBefore(targetNode, sourceNode);


                        // Reset selection styling
                        sourceNode.classList.remove('ring-2', 'ring-blue-500');
                        selectedPiece = null;

                        // Check if puzzle is solved after swap
                        checkPuzzleSolution();
                    }
                });
            });

            if (shuffleButton) {
                 shuffleButton.addEventListener('click', () => {
                    if (localState.isGameCompletedLocally) return;

                    if (selectedPiece) {
                        selectedPiece.classList.remove('ring-2', 'ring-blue-500');
                        selectedPiece = null;
                    }

                    // Simple shuffle: Reorder elements in the grid
                     const piecesArray = Array.from(puzzleGrid.children);
                     shuffleArray(piecesArray); // Use the shuffle helper
                     piecesArray.forEach(p => puzzleGrid.appendChild(p)); // Re-append in shuffled order
                });
            }
        }

        function checkPuzzleSolution() {
            const puzzleGrid = document.getElementById('puzzle-grid');
            if (!puzzleGrid) return;
            const puzzlePieces = puzzleGrid.querySelectorAll('.puzzle-piece');
            if (!puzzlePieces.length) return; // Already solved or error

             // Check if pieces are in order 1 through 9 based on their data-position attribute
            const isCorrect = Array.from(puzzlePieces).every((piece, index) => {
                // Ensure piece has the data attribute
                return piece.dataset.position && parseInt(piece.dataset.position) === index + 1;
            });


            if (isCorrect) {
                 console.log("Puzzle solved!");
                // Show the solution message within the grid area
                puzzleGrid.innerHTML = `
                    <div class="col-span-3 bg-yellow-100 p-4 rounded-lg">
                        <p class="font-bold text-center mb-3">¡Puzzle completado!</p>
                        <p class="text-center">La imagen revela una antigua llave con la palabra: <span class="font-bold text-red-600">LLAVE</span></p>
                         <p class="text-center text-sm mt-2">(Introduce "LLAVE" como solución)</p>
                    </div>
                `;
                // Update solution input (optional, user should type it)
                // const solutionInput = document.getElementById('solution-input');
                // if (solutionInput) solutionInput.value = 'LLAVE';
            }
        }

        function setupAudioListeners() {
             // Simulate audio player behavior without actual audio
            const playButton = document.getElementById('play-audio');
            const progressBar = document.getElementById('audio-progress-bar');
            const audioTime = document.getElementById('audio-time');
            const audioProgressContainer = document.getElementById('audio-progress'); // The container for click events

             // Check if elements exist
             if (!playButton || !progressBar || !audioTime || !audioProgressContainer) return;


            let isPlaying = false;
            let duration = 60; // seconds (simulated duration)
            let currentTime = 0;
            let audioInterval; // Use local interval, not global state

             function updateAudioUI() {
                 const progress = (currentTime / duration) * 100;
                 progressBar.style.width = `${progress}%`;
                 audioTime.textContent = `${formatAudioTime(currentTime)} / ${formatAudioTime(duration)}`;
             }

            playButton.addEventListener('click', () => {
                if (localState.isGameCompletedLocally) return; // No interaction if game completed

                 if (isPlaying) {
                    // Pause audio
                    clearInterval(audioInterval);
                    playButton.innerHTML = '<i class="fas fa-play"></i>';
                 } else {
                     // Play audio (or resume)
                     // Clear any existing interval before starting a new one
                     if (audioInterval) clearInterval(audioInterval);

                     audioInterval = setInterval(() => {
                        currentTime = (currentTime + 1);
                         if (currentTime > duration) {
                             currentTime = 0; // Loop back or stop? Let's stop.
                             clearInterval(audioInterval);
                             playButton.innerHTML = '<i class="fas fa-play"></i>';
                             isPlaying = false;
                         }
                         updateAudioUI();

                     }, 1000); // Update every second

                     playButton.innerHTML = '<i class="fas fa-pause"></i>';
                 }
                 isPlaying = !isPlaying;
                 updateAudioUI(); // Update immediately on click
            });

            audioProgressContainer.addEventListener('click', (e) => {
                 if (localState.isGameCompletedLocally) return;

                const rect = audioProgressContainer.getBoundingClientRect();
                const clickPosition = (e.clientX - rect.left) / rect.width;
                currentTime = Math.floor(clickPosition * duration);

                 // Clear interval if seeking while playing
                 if (isPlaying) {
                     clearInterval(audioInterval);
                      // Resume playing from new position immediately
                     audioInterval = setInterval(() => {
                         currentTime = (currentTime + 1);
                          if (currentTime > duration) {
                             currentTime = 0;
                             clearInterval(audioInterval);
                             playButton.innerHTML = '<i class="fas fa-play"></i>';
                             isPlaying = false;
                         }
                         updateAudioUI();
                     }, 1000);
                 }
                 updateAudioUI(); // Update UI immediately after seek
            });

             // Initialize display
             updateAudioUI();
        }


        function formatAudioTime(totalSeconds) {
             if (isNaN(totalSeconds) || totalSeconds < 0) return "00:00";
            const minutes = Math.floor(totalSeconds / 60);
            const secs = Math.floor(totalSeconds % 60);
            return `${minutes.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }


        function setupDecisionListeners() {
             const mapContainer = document.getElementById('map-container');
             if (!mapContainer) return; // Exit if map container not found

             // Define locations directly inside the function or globally if preferred
             const locations = {
                recibidor: { name: 'Recibidor', description: '...', options: ['salon', 'cocina', 'escaleras', 'jardin'] },
                salon: { name: 'Salón', description: '...', options: ['recibidor', 'biblioteca', 'comedor'] },
                cocina: { name: 'Cocina', description: '...', options: ['recibidor', 'despensa', 'comedor'] },
                escaleras: { name: 'Escaleras', description: '...', options: ['recibidor', 'planta_superior', 'sotano'] },
                jardin: { name: 'Jardín', description: '...', options: ['recibidor', 'pozo', 'cobertizo'] },
                biblioteca: { name: 'Biblioteca', description: '...', options: ['salon'] },
                comedor: { name: 'Comedor', description: '...', options: ['salon', 'cocina'] },
                despensa: { name: 'Despensa', description: '...', options: ['cocina'] },
                planta_superior: { name: 'Planta Superior', description: '...', options: ['escaleras', 'dormitorio_principal', 'habitacion_invitados', 'estudio'] },
                sotano: { name: 'Sótano', description: '¡Lo habéis encontrado!...', options: ['escaleras'], isTarget: true }, // Correct place
                pozo: { name: 'Pozo', description: '...', options: ['jardin'] },
                cobertizo: { name: 'Cobertizo', description: '...', options: ['jardin'] },
                dormitorio_principal: { name: 'Dormitorio Principal', description: '...', options: ['planta_superior'] },
                habitacion_invitados: { name: 'Habitación de Invitados', description: '...', options: ['planta_superior'] },
                estudio: { name: 'Estudio', description: '...', options: ['planta_superior'] }
            };
             // (Descriptions shortened for brevity)

             let currentLocationId = 'recibidor'; // Track current location locally within this challenge instance

             function updateLocationUI(locationId) {
                 if (localState.isGameCompletedLocally) return; // No interaction if game completed

                 currentLocationId = locationId; // Update local tracker
                 const locationData = locations[locationId];
                 const locationNameEl = document.getElementById('location-name');
                 const locationDescEl = document.getElementById('location-description');
                 const optionsContainer = document.getElementById('location-options');
                 const mapContainer = document.getElementById('map-container'); // For adding success message

                 if (!locationData || !locationNameEl || !locationDescEl || !optionsContainer || !mapContainer) return; // Check elements

                 locationNameEl.textContent = locationData.name;
                 locationDescEl.textContent = locationData.description;

                 // Clear previous options and success message
                 optionsContainer.innerHTML = '';
                  const existingSuccess = mapContainer.querySelector('.success-message');
                  if (existingSuccess) mapContainer.removeChild(existingSuccess);


                 // Add new options
                 locationData.options.forEach(optionId => {
                    const optionData = locations[optionId];
                    if (!optionData) return; // Skip if option ID is invalid

                    const button = document.createElement('button');
                    button.className = 'location-option block w-full bg-white hover:bg-gray-100 py-2 px-4 border rounded text-left mb-2'; // Added mb-2
                    button.dataset.destination = optionId; // Use dataset
                    button.innerHTML = `<i class="fas fa-door-open mr-2 text-gray-500"></i> Ir a ${optionData.name}`;

                    button.addEventListener('click', () => updateLocationUI(optionId)); // Recursive call
                    optionsContainer.appendChild(button);
                 });

                 // Check if this is the target location
                 if (locationData.isTarget) {
                     // Add a success message
                     const successMessage = document.createElement('div');
                     successMessage.className = 'mt-4 p-3 bg-green-100 border-l-4 border-green-500 text-green-700 success-message'; // Added class to find/remove later
                     successMessage.innerHTML = `
                        <p class="font-bold">¡Habéis encontrado el lugar correcto!</p>
                        <p>La palabra clave parece ser el nombre de este lugar. Introducidla en el campo de solución.</p>
                     `;
                     mapContainer.appendChild(successMessage);
                      // Optionally fill the input
                      // const solutionInput = document.getElementById('solution-input');
                      // if (solutionInput) solutionInput.value = 'SOTANO';
                 }
             }

             // Initial setup for the first location
             updateLocationUI(currentLocationId);
        }


        function setupFinalListeners() {
            const hiddenClues = document.querySelectorAll('.hidden-clue');
            hiddenClues.forEach(clue => {
                 // Ensure listener isn't added multiple times if challenge reloads
                 clue.replaceWith(clue.cloneNode(true)); // Simple way to remove old listeners
            });

            document.querySelectorAll('.hidden-clue').forEach(clue => {
                 clue.addEventListener('click', () => {
                     if (localState.isGameCompletedLocally) return; // No interaction if game completed
                     clue.classList.add('revealed');
                 });
            });
        }


        function shuffleArray(array) {
            for (let i = array.length - 1; i > 0; i--) {
                const j = Math.floor(Math.random() * (i + 1));
                [array[i], array[j]] = [array[j], array[i]]; // Swap elements
            }
            return array; // Return the mutated array
        }

    </script>

</body>
</html>